#+TITLE: BUG-005 Fix Infinite Loop Bugs in Non-Manuscript Pages
#+AUTHOR: Sakya Development Team
#+STARTUP: overview

* BUG-005 Fix Infinite Loop Bugs in Non-Manuscript Pages
:PROPERTIES:
:CUSTOM_ID: BUG-005
:GOAL: Eliminate infinite loop bugs in entity/schema/backlinks $effect blocks that cause excessive IPC calls and UI freezes.
:COMPLETION: No infinite IPC calls on empty-schema projects; entity save does not trigger full list reload; per-type loading prevents duplicate fetches.
:END:

** DONE Write failing unit tests for EntityStore infinite loop guards
:PROPERTIES:
:CUSTOM_ID: ITEM-186
:AGENT: [[file:../agents/testing-engineer.org::#core][testing-engineer:core]]
:EFFORT: 1h
:PRIORITY: #A
:FILES: src/lib/stores/entities.test.ts
:TEST_PLAN: test-svelte
:END:

*** Description
Write Vitest unit tests that expose the infinite loop bugs before fixing them.

*** Acceptance Criteria
- [X] Test: ~schemasLoaded~ is true after loading empty schema list (not based on array length)
- [X] Test: per-type loading flags prevent concurrent duplicate loads
- [X] Test: ~saveEntity~ does NOT delete ~entitiesByType[type]~ (no invalidation)
- [X] Test: ~isLoading~ derived flag reflects all sub-flags correctly
- [X] All new tests FAIL (RED phase) before store refactor

** DONE Refactor EntityStore: loadedPath, per-type loading, in-place save
:PROPERTIES:
:CUSTOM_ID: ITEM-187
:AGENT: [[file:../agents/svelte-developer.org::#core][svelte-developer:core]]
:EFFORT: 2h
:PRIORITY: #A
:FILES: src/lib/stores/entities.svelte.ts
:TEST_PLAN: test-svelte
:END:

*** Description
Refactor EntityStore to fix bugs 1-4:
- Replace ~schemasLoaded~ with ~schemasLoadedPath~ pattern (path-based tracking)
- Split ~isLoading~ into ~isLoadingSchemas~, ~isLoadingEntities~ (per-type Record), ~isSaving~
- Add per-type loading guard in ~loadEntities~
- Replace ~invalidateType~ with ~updateEntityInList~ for saves, ~reloadEntities~ for creates/deletes

*** Acceptance Criteria
- [X] ~schemasLoadedPath~ tracks which project's schemas are loaded
- [X] ~isLoadingSchemas~, ~isLoadingEntities~, ~isSaving~ are independent flags
- [X] ~isLoading~ is a convenience derived that ORs all sub-flags
- [X] ~loadEntities~ checks per-type loading guard before fetching
- [X] ~saveEntity~ updates in-place without deleting type cache
- [X] ~createEntity~, ~deleteEntity~, ~renameEntity~ call ~reloadEntities~
- [X] All ITEM-186 tests pass (GREEN)

** DONE Write failing E2E tests for infinite loop regression
:PROPERTIES:
:CUSTOM_ID: ITEM-188
:AGENT: [[file:../agents/testing-engineer.org::#core][testing-engineer:core]]
:EFFORT: 1h
:PRIORITY: #A
:FILES: e2e/infinite-loop-guards.spec.ts, e2e/utils/tauri-mocks.ts
:TEST_PLAN: e2e
:END:

*** Description
Write E2E tests + helpers that catch infinite loops via IPC call counting and console error monitoring.

*** Acceptance Criteria
- [X] Test: empty schema project (~list_schemas~ returns ~[]~), assert called exactly once
- [X] Test: idle IPC audit (no IPC calls in 3s idle period after settle)
- [X] Test: entity save does NOT trigger ~list_entities~
- [X] Test: multi-type load (3+ schemas), each ~list_entities~ called once per type
- [X] Test: console error monitoring during normal operation

** DONE Fix BinderTree + BacklinksSection effects
:PROPERTIES:
:CUSTOM_ID: ITEM-189
:AGENT: [[file:../agents/svelte-developer.org::#core][svelte-developer:core]]
:EFFORT: 1h
:PRIORITY: #A
:FILES: src/lib/components/binder/BinderTree.svelte, src/lib/components/inspector/BacklinksSection.svelte
:TEST_PLAN: e2e
:END:

*** Description
Fix component-level ~$effect~ blocks:
- BinderTree schema effect: use ~schemasLoadedPath~ guard
- BinderTree entity effect: use ~untrack()~ + per-type loading guards
- BacklinksSection: wrap ~fetchBacklinks~ in ~untrack()~

*** Acceptance Criteria
- [X] Schema loading effect uses path-based guard, not array length
- [X] Entity loading effect uses ~untrack()~ to prevent reactive cascade
- [X] BacklinksSection captures reactive props then calls async in ~untrack()~
- [X] All ITEM-188 E2E tests pass (GREEN)
- [X] All existing E2E tests pass (regression)

** DONE Full regression verification
:PROPERTIES:
:CUSTOM_ID: ITEM-190
:AGENT: [[file:../agents/testing-engineer.org::#core][testing-engineer:core]]
:EFFORT: 30m
:PRIORITY: #B
:FILES: (verification only)
:TEST_PLAN: compile, test-rust, test-svelte, e2e
:END:

*** Description
Run full test suite and linting to verify no regressions.

*** Acceptance Criteria
- [X] ~bun run test~ passes (Vitest — 13 new tests)
- [X] ~bun run test:e2e~ passes (258 E2E tests, +6 new)
- [X] ~cargo test~ passes (388 Rust tests)
- [X] ~cargo clippy~ has 0 warnings
- [X] ~bun run check~ passes (svelte-check — 0 errors, 0 warnings)
